# Amazon Managed Workflows for Apache Airflow (MWAA) - サービスアーキテクチャ

このドキュメントでは、Amazon Managed Workflows for Apache Airflow (MWAA) のサービスアーキテクチャについて説明します。

## アーキテクチャ概要

Amazon MWAAは、Apache Airflowのマネージドサービスであり、ワークフローオーケストレーションを簡単に実行できるようにします。基盤となるインフラストラクチャを管理する運用上の負担なく、Apache Airflowを使用してデータパイプラインを構築・監視できます。

## 主要コンポーネント

### MWAA環境内のコンポーネント

1. **スケジューラ (Scheduler)**
   - DAGを解析・監視し、依存関係が満たされたタスクを実行キューに入れる
   - AWS Fargateクラスターとして実装され、最小2つのスケジューラが配置される
   - ワークロードに応じて最大5つまで増やすことが可能

2. **ワーカー (Worker)**
   - スケジュールされたタスクを実行するFargateタスク
   - 指定された最小数と最大数の範囲内で自動的にスケーリング
   - キューに入れられたタスクと実行中のタスクの数に基づいて自動的にスケーリング

3. **Webサーバー (Web Server)**
   - Apache Airflow Web UIを実行
   - パブリックネットワークまたはプライベートネットワークアクセスモードで構成可能
   - IAMポリシーによるアクセス制御

4. **メタデータデータベース (Database)**
   - Apache Airflow環境とワークフローに関するメタデータを保存
   - DAG実行履歴などの情報を管理
   - AWS管理のシングルテナントAurora PostgreSQLデータベース
   - VPCエンドポイントを介してスケジューラとワーカーからアクセス可能

### 連携するAWSサービス

1. **Amazon S3**
   - DAG、要件ファイル、プラグインなどのワークフローリソースを保存
   - MWAAがこのバケットからリソースを読み込む

2. **Amazon CloudWatch**
   - Apache Airflowのログとメトリクスを収集
   - 環境の監視とトラブルシューティングに使用

3. **Amazon SQS**
   - Celeryエグゼキューターを使用したワークフロータスクのキューイングに使用

4. **AWS KMS**
   - データの暗号化を保証
   - デフォルトではAWS管理のKMSキーを使用するが、カスタマー管理のKMSキーも設定可能

5. **AWS IAM**
   - Apache Airflow Webサーバーへのロールベースの認証と承認を提供
   - ユーザーアクセスの制御

## ネットワーク構成

MWAAは、2つの異なるアベイラビリティーゾーンにまたがる2つのプライベートサブネットを必要とします。これにより、一方のアベイラビリティーゾーンで障害が発生した場合でも、環境の高可用性が確保されます。

### アクセスモード

MWAAは2つのアクセスモードをサポートしています：

1. **パブリックネットワークアクセスモード**
   - Apache Airflow Webサーバーへのトラフィックがインターネット経由でルーティングされる
   - メタデータデータベース用のVPCインターフェースエンドポイントが作成される

2. **プライベートネットワークアクセスモード**
   - Apache Airflow WebサーバーへのトラフィックがVPC内でプライベートにルーティングされる
   - Webサーバー用とメタデータデータベース用の両方のVPCインターフェースエンドポイントが作成される

## セキュリティ

- すべてのデータはAWS KMSを使用して自動的に暗号化される
- IAMポリシーによるアクセス制御
- VPC内でのプライベート通信
- セキュリティグループによるネットワークトラフィックの制御

## スケーリング

- ワーカーは設定された最小数と最大数の範囲内で自動的にスケーリング
- キューに入れられたタスクと実行中のタスクの数に基づいて自動的にスケーリング
- 2分以上タスクがゼロの場合、ワーカー数は最小値に戻る

## 監視

- CloudWatchと統合されており、Apache Airflowのログとメトリクスを自動的に送信
- 環境のパフォーマンスとヘルスを監視可能
- SchedulerHeartbeatメトリクスによるAirflowの健全性の監視

## AWS Well-Architected Frameworkとの整合性

このアーキテクチャは、AWS Well-Architected Frameworkの以下の柱に準拠しています：

1. **運用上の優秀性**
   - マネージドサービスによる運用オーバーヘッドの削減
   - CloudWatchによる監視と可視性

2. **セキュリティ**
   - IAMによるアクセス制御
   - KMSによるデータ暗号化
   - VPC内でのプライベート通信

3. **信頼性**
   - 複数のアベイラビリティーゾーンにまたがる配置
   - 自動スケーリングによる需要への対応

4. **パフォーマンス効率**
   - 需要に応じた自動スケーリング
   - マネージドサービスによるパフォーマンス最適化

5. **コスト最適化**
   - 使用したリソースに対してのみ課金
   - 自動スケーリングによる効率的なリソース使用

## まとめ

Amazon MWAAは、Apache Airflowの運用負担を軽減しながら、スケーラブルで高可用性のワークフローオーケストレーションを提供します。AWS Well-Architected Frameworkに準拠した設計により、セキュアで信頼性の高いサービスとなっています。 