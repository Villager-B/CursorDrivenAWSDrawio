# Amazon MWAA - プライベートネットワークモードアーキテクチャ

このアーキテクチャは、Amazon Managed Workflows for Apache Airflow (MWAA) をプライベートネットワークモードで実装したものです。プライベートネットワークモードでは、Apache Airflow Web UIへのアクセスはVPC内からのみ可能となり、インターネットからの直接アクセスはできません。

## アーキテクチャの概要

このアーキテクチャは、AWS Well-Architected Frameworkに準拠し、セキュリティ、信頼性、パフォーマンス効率、コスト最適化、運用上の優秀性の5つの柱を考慮して設計されています。

### 主要コンポーネント

1. **Amazon MWAA環境**
   - プライベートネットワークモードで構成
   - Apache Airflow Webサーバー、スケジューラー、ワーカーを管理
   - VPC内の2つのプライベートサブネットにデプロイ

2. **Amazon S3バケット**
   - DAGファイル、プラグイン、requirements.txtを保存
   - プライベートモードでは、依存関係をPython wheelアーカイブ（.whl）としてパッケージ化する必要あり

3. **Amazon Aurora PostgreSQL**
   - Apache Airflowのメタデータデータベースとして使用
   - MWAAによって自動的に管理

4. **Amazon CloudWatch Logs**
   - Apache Airflowのログを収集・モニタリング

5. **VPCエンドポイント**
   - S3ゲートウェイエンドポイント
   - CloudWatch、ECR、STS、KMS用のインターフェースエンドポイント
   - プライベートサブネット内のリソースがAWSサービスにプライベートに接続可能

6. **AWS Client VPN**
   - 企業ネットワークからVPC内のリソースへの安全なアクセスを提供
   - Apache Airflow Web UIへのアクセスに必要

7. **IAM実行ロール**
   - MWAAが他のAWSサービスにアクセスするために必要な権限を定義

8. **AWS KMS**
   - データ暗号化のためのキー管理

## セキュリティ上の考慮事項

1. **ネットワークセキュリティ**
   - すべてのMWAAコンポーネントはプライベートサブネット内に配置
   - VPCエンドポイントを使用してAWSサービスにプライベート接続
   - Client VPNを通じた認証済みユーザーのみがAirflow Web UIにアクセス可能

2. **アクセス制御**
   - IAMポリシーによるきめ細かなアクセス制御
   - 最小権限の原則に基づいた実行ロールの設定

3. **データ保護**
   - KMSによるデータの暗号化
   - S3バケット内のDAGファイルとプラグインの暗号化

## 運用上の考慮事項

1. **依存関係管理**
   - プライベートモードでは、すべての依存関係をPython wheelアーカイブ（.whl）としてパッケージ化し、requirements.txtで参照する必要があります

2. **ネットワークアクセス**
   - Apache Airflow Web UIにアクセスするには、Client VPNなどのメカニズムを設定する必要があります

3. **モニタリングとログ記録**
   - CloudWatch Logsを使用してApache Airflowのログを収集・分析
   - CloudWatch Alarmsを設定して異常を検出

## コスト最適化

1. **環境クラスのサイジング**
   - ワークロードに適した環境クラスを選択
   - 必要に応じて環境クラスを変更可能

2. **ワーカー数の最適化**
   - 最大ワーカー数を適切に設定
   - 自動スケーリングによりコスト効率を向上

3. **Webサーバーの自動スケーリング**
   - 最小および最大Webサーバー数を設定して、需要に応じてスケーリング

## アーキテクチャ図の改善点

最新版のアーキテクチャ図では、以下の改善を行いました：

1. **接続フローの明確化**
   - 各AWSサービスとVPCエンドポイント間の接続を明示的に表示
   - IAMとKMSからMWAAへの接続を追加し、権限と暗号化の関係を明確化

2. **レイアウトの最適化**
   - コンポーネントの配置を整理し、論理的な関係をより明確に表現
   - 矢印の方向と流れを統一して可読性を向上

3. **AWS2025アイコンセットの適切な使用**
   - 各サービスカテゴリに対して正しい色を使用
   - アイコンの一貫性を確保

4. **セキュリティフローの強調**
   - プライベートネットワークモードの特徴であるVPCエンドポイントを経由した安全な通信パスを強調
   - 企業ネットワークからのアクセスパスを明確化

これらの改善により、MWAAプライベートネットワークモードの重要な特徴と、各コンポーネント間の関係がより明確に表現されています。

## まとめ

このプライベートネットワークモードのMWAAアーキテクチャは、セキュリティを重視する企業や規制の厳しい業界向けに設計されています。インターネットからの直接アクセスを制限し、VPC内でのプライベート通信を確保することで、セキュリティを強化しながらApache Airflowの管理機能を提供します。 